# Jabil Feedback System API

This repository contains a FastAPI reference implementation of the Jabil Feedback System outlined in `docs/complaint-system-framework.md`. The service exposes endpoints for authentication, feedback intake, AI-assisted classification, replies with email notifications, analytics, reporting, and secure attachment handling.

## Getting Started

```powershell
python -m venv .venv
.\.venv\Scripts\activate


uvicorn app.main:app --reload
```

The API will be available at `http://localhost:8000`. Interactive Swagger UI can be accessed at `/docs`.

> Tip: copy `.env.example` to `.env` and fill in secrets like `GROQ_API_KEY` so the backend picks them up automatically.

### Frontend (React + Vite)

The React client lives under `frontend/` and consumes the FastAPI endpoints.

```powershell
cd frontend
# Install packages (requires Node 18+)
npm install
npm run dev
```

Set `VITE_API_URL` in `frontend/.env` if your backend runs on a different host/port. The default dev server listens on `http://localhost:5173`.

## Environment Variables

Key settings (with defaults) can be overridden via the environment:

| Variable | Description | Default |
| --- | --- | --- |
| `NODE_ENV` | Environment label | `development` |
| `JWT_SECRET` | Token signing secret | `dev-secret-key` |
| `JWT_EXPIRES_IN_MINUTES` | Access token TTL | `30` |
| `REFRESH_TOKEN_EXPIRES_IN_MINUTES` | Refresh token TTL | `10080` |
| `EMAIL_FROM` | Sender email address | `noreply@company.com` |
| `SMTP_HOST`/`SMTP_PORT`/`SMTP_USER`/`SMTP_PASS` | Email provider settings | SendGrid defaults |
| `UPLOAD_DIR` | Attachment storage path | `./uploads` |
| `ALLOWED_FILE_TYPES` | CSV of MIME types | `image/jpeg,image/png,video/mp4,application/pdf` |
| `MAX_FILE_SIZE` | Upload limit in bytes | `10485760` |
| `GROQ_API_KEY` | Groq API key for AI features | _required for AI_ |
| `GROQ_MODEL` | Groq model name | `llama-3.3-70b-versatile` |
| `CORS_ALLOW_ORIGINS` | Comma-separated origins allowed by CORS | `http://localhost:5173` |
| `BCRYPT_ROUNDS` | Bcrypt cost factor (security vs CPU) | `12` |
| `LOG_FORMAT` | `json` or `text` log output | `json` |
| `REQUEST_ID_HEADER` | Header name used for request correlation | `X-Request-ID` |
| `SLA_HOURS_NORMAL` | SLA target (hours) for normal-priority feedback | `72` |
| `SLA_HOURS_URGENT` | SLA target (hours) for urgent-priority feedback | `24` |
| `REPORT_SCHEDULE_CRON` | Optional cron expression overriding day/time | _unset_ |
| `REPORT_DAY` | Day of week to generate weekly report (`mon`-`sun`) | `mon` |
| `REPORT_TIME` | Local time (HH:MM) for weekly report job | `08:00` |
| `REPORT_TIMEZONE` | IANA timezone for scheduler | `UTC` |
| `REPORT_RECIPIENTS_DEFAULT` | CSV of email recipients for weekly report | _unset_ |
| `REPORT_RECIPIENTS_<DEPT>` | Dept-specific weekly report recipients | _unset_ |

## API Overview

- **Authentication** (`/api/auth`) ‚Äì login, refresh, logout, verify routes with in-memory token store.
- **Complaints** (`/api/complaints`) ‚Äî CRUD operations, filtering, auto AI classification, plus `/api/complaints/:id/assist` for action recommendations and reply drafting. Supports pagination via `page`, `page_size`, `sort` (`created_at|priority|status`), `order` (`asc|desc`) and filter params (`kind`, `status`, `priority`, `plant`, `from_date`, `to_date`).
- **Replies** (`/api/replies`) ‚Äì admin responses with optional email delivery via the pluggable `EmailService`.
- **Analytics** (`/api/analytics`) ‚Äì dashboard metrics, trend data, and executive summaries (Claude-style heuristics).
- **Reports** (`/api/reports`) ‚Äì generate/download summary reports for weekly/monthly/yearly periods.
- **Files** (`/api/upload`, `/api/files/:id`) ‚Äì attachment upload/download/delete with server-side validation.
- **Department Analytics** (`/api/analytics/department-stats`) ‚Äì per-category rollups showing totals, SLA breach rate, reopen rate, and backlog age.
- **Weekly Reports** (`/api/reports/weekly`) ‚Äì list and view HTML/text weekly summaries generated by the background scheduler.
- **Feedback Presets** (`/api/profile/presets/feedback`) ‚Äì store per-user filter presets for the All Feedback dashboard.
- **Email Templates** (`templates/email/`) ‚Äì MJML-lite + Jinja templates rendered at runtime for reply notifications and weekly reports.

An admin seed user (`admin` / `admin123`) is added on startup. Use the `Authorization: Bearer <token>` header for protected routes.

Password policy: minimum length 10 characters. Passwords are stored with bcrypt; legacy hashes are upgraded on first successful login.

Errors: API errors use a consistent shape `{ code, message, correlation_id }`. Responses include a request ID header (default `X-Request-ID`, configurable via `REQUEST_ID_HEADER`) so you can correlate client calls with log entries.

To correlate logs with API calls:
1. Capture or supply the `REQUEST_ID_HEADER` value on each request.
2. Look for log entries containing the matching `request_id` field in `logs/app.log`.

## Testing the Service

You can run a quick smoke test by executing:

```powershell
.\.venv\Scripts\python -m uvicorn app.main:app --reload
```

Then use the Swagger UI or `curl`/Postman to exercise endpoints. Because persistence is in-memory, restarting the server clears all data. Integrate a real database/AI provider by replacing `app/datastore.py` and `app/services/ai.py` respectively.

## Deployment

- **Render.com**: Follow `docs/render-deployment.md` for a step-by-step guide (backend web service + frontend static site, persistent disk setup, and environment variables).

## üöÄ Features

- **Smart Complaint Processing**: AI-powered analysis using Groq LLM
- **Real-time Updates**: Live status tracking and notifications
- **File Attachments**: Support for evidence and documentation uploads
- **Role-based Access**: Secure authentication with JWT
- **Analytics Dashboard**: Insights into complaint trends and SLA compliance
- **Filter Presets**: Save named combinations of feedback filters and re-apply them in one click
- **Responsive Design**: Modern UI with Tailwind CSS and smooth animations
- **Rich Email Notifications**: Branded HTML + plain-text emails with retry queue and template-driven content

## üõ†Ô∏è Tech Stack

### Backend
- **FastAPI**: High-performance Python web framework
- **SQLAlchemy**: Database ORM
- **Groq API**: AI-powered complaint analysis
- **JWT**: Secure authentication
- **Python 3.11+**: Latest Python features

### Frontend
- **React 18**: Modern UI library
- **TypeScript**: Type-safe development
- **Vite**: Fast build tool
- **Zustand**: Lightweight state management
- **Tailwind CSS**: Utility-first styling
- **React Router**: Client-side routing

## üìÅ Project Structure

```
feedback-v3/
‚îú‚îÄ‚îÄ app/                    # FastAPI backend
‚îÇ   ‚îú‚îÄ‚îÄ routers/           # API route handlers
‚îÇ   ‚îú‚îÄ‚îÄ services/          # Business logic layer
‚îÇ   ‚îú‚îÄ‚îÄ config.py          # Configuration management
‚îÇ   ‚îú‚îÄ‚îÄ models.py          # Database models
‚îÇ   ‚îî‚îÄ‚îÄ datastore.py       # Data access layer
‚îú‚îÄ‚îÄ frontend/              # React frontend
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/          # API integration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/   # Reusable UI components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ store/        # Zustand state management
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types/        # TypeScript definitions
‚îÇ   ‚îî‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ docs/                  # Documentation
‚îú‚îÄ‚îÄ uploads/              # File attachments
‚îú‚îÄ‚îÄ logs/                 # Application logs
‚îî‚îÄ‚îÄ .env.example          # Environment template
```
- **Scheduled Weekly Reports**: APScheduler triggers the weekly digest job (defaults to Mondays 08:00 UTC). Adjust timing via the `REPORT_*` environment variables; the scheduler starts with the API process and shuts down cleanly on exit.
### Feedback Filters & Presets

- The **All Feedback** page accepts query parameters (`kind`, `status`, `priority`, `plant`, `from`, `to`, `page`, `pageSize`, `sort`, `order`) so views can be bookmarked or shared.
- Admins can save named presets via the presets toolbar (stored per user through `GET/PUT /api/profile/presets/feedback`).
- Presets capture the current filter state and appear in a quick selector for fast application; updating an existing preset overwrites the stored filters.
### Email Templates

- Templates live under `templates/email/` ‚Äì e.g., `reply.html`/`.txt` for feedback replies, `weekly_report.html`/`.txt` for scheduled reports.
- Render emails via `render_email(template_name, context)`; it returns HTML and plain-text bodies plus an inferred subject (can be overridden via context).
- Update or add templates without code changes; restart the backend to ensure the template cache reloads.
- The email service (`app/services/email.py`) falls back to a retry queue processed every minute; failures are logged with details.
